{% extends '_layouts/admin/main.html.twig' %}

{% block page %}Quản Lý Danh Mục{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-xl-12">
            <div>
                <div class="col-xl-3 mb-3">
                    <a href="{{ path('admin_category_create') }}"
                       class="btn btn-lg btn-primary btn-block waves-effect waves-light ">
                        <i class="fa fa-plus mr-1"></i> Thêm Danh Mục
                    </a>
                </div>
                <table id="category-datatable-buttons"
                       class="table table-striped table-bordered dt-responsive nowrap"
                       style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                    <thead>
                    <tr>
                        <th><input type="checkbox" class="category-select-all"></th>
                        <th>Mã Danh mục</th>
                        <th>Tên danh mục</th>
                        <th>Thư Mục Cha</th>
                        <th>Trạng Thái</th>
                        <th>Số DM Con</th>
                        <th>Ảnh</th>
                        <th>Mô tả</th>
                        <th></th>
                    </tr>
                    </thead>
                        <tbody></tbody>
                    <tfoot>
                    <tr>
                        <th><input type="checkbox" class="category-select-all"></th>
                        <th>Mã Danh mục</th>
                        <th>Tên danh mục</th>
                        <th>Thư Mục Cha</th>
                        <th>Trạng Thái</th>
                        <th>Số DM Con</th>
                        <th>Ảnh</th>
                        <th>Mô tả</th>
                        <th></th>
                    </tr>
                    </tfoot>
                </table>
                <button type="button" class="col-1 category-bulk-delete-btn btn btn-lg btn-danger btn-block waves-effect waves-light">Xoá</button>
            </div>
        </div>
        <!-- end col -->
    </div>


{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="module">
        $(document).ready(function () {
            let table = $('#category-datatable-buttons tbody')
            // get list categories
            $.ajax({
                url: '{{ url('admin_category_list') }}',
                type: 'GET',
                contentType: 'application/json',
                success: function (data) {
                    table.empty();

                    console.log(data);

                    $.each(data, function (index, item) {
                        table.append('<tr>' +
                            '<td><input type="checkbox" class="row-category-checkbox" value="'+ item.id +'" "></td>' +
                            '<td>' + item.slug + '</td>' +
                            '<td>' + item.name + '</td>' +
                            '<td>' + (item.parent !== "-" ? item.parent : 'Khong Co') + '</td>' +
                            '<td>' + (item.status === 0 ? 'INACTIVE' : (item.status === 1 ? 'ACTIVE' : 'DRAFT')) + '</td>' +
                            '<td>' + item.childrens + '</td>' +
                            '<td>' + item.image + '</td>' +
                            '<td>' + item.description + '</td>' +
                            '<td>' +
                            '<a style="margin-right: 7px" href="'+ item.actions.detail +'"><i class="fa fa-info-circle"></i></a>' +
                            '<a style="margin-right: 7px" href="'+ item.actions.update +'"><i class="fa fa-edit"></i></a>' +
                            '<a data-url="'+ item.actions.delete +'" class="btn-delete" href="#"><i class="fa fa-trash"></i></a>' +
                            '</td>' +
                            '</tr>'
                        );
                    });
                    // Create datatable
                    const a = $("#category-datatable-buttons").DataTable({
                        lengthChange: !1,
                        buttons: ["copy", "excel", "pdf"],
                        columnDefs: [
                            {orderable: false, targets: 6},
                            {searchable: false, targets: 6},
                            {width: '1%', targets: 0},
                            {width: '5%', targets: 1},
                            {width: '15%', targets: 2},
                            {width: '15%', targets: 3},
                            {width: '14%', targets: 4},
                            {width: '14%', targets: 5},
                            {width: '14%', targets: 6},
                            {width: '15%', targets: 7},
                            {width: '5%', targets: 8},
                        ],
                        initComplete:
                            function () {
                                this.api()
                                    .columns()
                                    .every(function () {
                                        let column = this;

                                        if (column.index() === 7 || column.index() === 0) {
                                            return;
                                        }

                                        let input = document.createElement('input');
                                        input.type = 'text';
                                        input.style.width = '100%';
                                        input.placeholder = 'Search...';
                                        column.footer().replaceChildren(input);

                                        input.addEventListener('input', function () {
                                            column
                                                .search(input.value, {exact: false})
                                                .draw();
                                        });
                                    });
                            }
                    });
                    a.buttons().container().appendTo("#category-datatable-buttons_wrapper .col-md-6:eq(0)")
                }
            });
            // Delete category
            $(document).on('click', '.btn-delete', function () {
                let deleteUrl = $(this).data('url');

                if (confirm('Bạn có chắc chắn muốn xóa?')) {
                    $.ajax({
                        url: deleteUrl,
                        type: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function () {
                            alert('Xóa thành công!');
                            location.reload();
                        },
                        error: function () {
                            alert('Có lỗi xảy ra khi xóa!');
                        }
                    });
                }
            });
        });
    </script>
    <script >
        // Handle "Select All" checkbox
        $('.category-select-all').on('click', function () {
            $('.row-category-checkbox').prop('checked', this.checked);
            $('.category-select-all').prop('checked', this.checked);
        });

        // Collect id has checked
        function getSelectedIds() {
            var selected = [];
            $('.row-category-checkbox:checked').each(function () {
                selected.push($(this).val());
            });
            return selected;
        }
    </script>
    <script>
        //Handle bulk delete
        $('.category-bulk-delete-btn').on('click', function () {
            var ids = getSelectedIds();
            if (ids.length === 0) {
                alert('Không có ô nào đươc chọn');
                return;
            }
            console.log(ids);

            if (confirm('Bạn có muốn xoá các danh mục này?')) {
                $.ajax({
                    url: '{{ path('admin_category_bulk_delete') }}',
                    type: 'POST',
                    data: { 'ids': ids },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function () {
                        alert('Xóa thành công!');
                        location.reload();
                    },
                    error: function () {
                        alert('Có lỗi xảy ra khi xóa!');
                    }
                });
            }
        });
    </script>
{% endblock %}
